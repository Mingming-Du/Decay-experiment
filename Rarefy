library(phyloseq)
library(vegan)
library(data.table)
library(readxl)

# ---- Define file paths ----
asv_file_path <- "C:/Users/midu6195/OneDrive - The University of Sydney (Staff)/PhD project/Research-1-soil DNA extraction/4.1/original/asv_table.csv"
tax_file_path <- "C:/Users/midu6195/OneDrive - The University of Sydney (Staff)/PhD project/Research-1-soil DNA extraction/4.1/original/tax_table.csv"
sample_metadata_path <- "C:/Users/midu6195/OneDrive - The University of Sydney (Staff)/PhD project/Research-1-soil DNA extraction/4.1/original/sam_table.csv"

# ---- Read original ASV, taxonomy, and sample metadata tables ----
# fread/read.csv automatically treat the first line as column names
asv_data <- fread(asv_file_path, header = TRUE, data.table = FALSE)
tax_data <- fread(tax_file_path, header = TRUE, data.table = FALSE)
sample_data <- fread(sample_metadata_path, header = TRUE, data.table = FALSE)

# ---- Set the first column as row names ----
rownames(asv_data) <- asv_data$SampleID      # assuming first column = SampleID
rownames(tax_data) <- tax_data$SampleID
rownames(sample_data) <- sample_data$SampleID

# ---- Remove the first column ----
asv_data <- asv_data[, -1]
tax_data <- tax_data[, -1]
sample_data <- sample_data[, -1]

# # Ensure Time and Storage are factors
# sample_data$Time <- as.factor(sample_data$Time)
# sample_data$Storage <- as.factor(sample_data$Storage)

# ---- Create phyloseq object ----
physeq_obj <- phyloseq::phyloseq(
  otu_table(as.matrix(asv_data), taxa_are_rows = FALSE), 
  tax_table(as.matrix(tax_data)),  
  sample_data(sample_data)
)

# ---- Subset: keep only Bacteria; remove mitochondria and chloroplasts ----
physeq_obj <- physeq_obj %>% 
  subset_taxa(Kingdom == "Bacteria") %>%
  subset_taxa(!(Family %in% "Mitochondria") &
                !(Order %in% "Chloroplast"))

# ---- Remove taxa with very low abundance ----
physeq_obj <- prune_taxa(taxa_sums(physeq_obj) > 15, physeq_obj)
physeq_obj <- filter_taxa(physeq_obj, function(x) sum(x > 0) > 2, TRUE)

summary(taxa_sums(physeq_obj))
physeq_obj
print(physeq_obj)

# ---- Check sample sequencing depth ----
sample_sums <- rowSums(otu_table(physeq_obj))
min_read <- min(sample_sums)
min_read

# ---- Rarefaction ----
# set.seed(123)  # uncomment for reproducibility
physeq_rarefied <- rarefy_even_depth(
  physeq_obj, sample.size = 33000, rngseed = 123, replace = TRUE
)
# physeq_rarefied <- physeq_obj  # if no rarefaction needed

# ---- Extract rarefied OTU/ASV table ----
otu_table_rarefied <- otu_table(physeq_rarefied)
asv_table <- as.data.frame(as.matrix(otu_table_rarefied))

# ---- Extract taxonomy table ----
tax_table <- tax_table(physeq_rarefied)
tax_table <- as.data.frame(as.matrix(tax_table))

# ---- Save results ----
setwd("C:/Users/midu6195/OneDrive - The University of Sydney (Staff)/PhD project/Research-1-soil DNA extraction/PeerJ/table/original")

write.csv(asv_table, file = "asv_table.csv", row.names = TRUE)
write.csv(tax_table, file = "tax_table.csv", row.names = TRUE)
